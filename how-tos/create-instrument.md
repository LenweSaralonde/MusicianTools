Create a new instrument
=======================

## Requirements
This is the software you need to create new instruments for Musician:
* [node.js](https://nodejs.org/)
* [Python 3](https://www.python.org/downloads/)
* [ffmpeg](https://ffmpeg.org/)
* [ffmpeg-normalize](https://github.com/slhck/ffmpeg-normalize)
* DAW, sound editing software...
* Code editor (VSCode), git etc.

## 1. Create a blank add-on
The best way to add instruments in Musician is by creating a plugin add-on that may contain one or more instruments.

## 2. Make the master sample

The master sample file is a WAV file that contains all the 6-second instrument samples in a row from key C0 to C8 (included).

The easiest way is to make it from a virtual instrument in a DAW:
1. Import the `instrument-template/6-second-C0-C8.mid` file in your DAW.
2. Assign the instrument you want to export to the track.
3. Make adjustments, add effects if needed.
4. Export to WAV.

## 3. Generate the sample files

The sample files are generated by slicing the master sample, using the **slicer** tool.

Each sample is normalized and compressed into OGG format.

Recommended normalization parameters are `-20 dB` using `RMS` for continuous looped instruments such as *violin*, *flute* etc. and `-10 dB` using `peak` for plucked instruments such as *guitar*, *piano* etc. These parameters should be tested in game so the generated instrument loudness is equivalent to the other instruments.

### Slicer tool usage

```
 node slicer.js [<options>] <wav file> [<output dir>]
```

Options:
* `-l <normalize level>` : Normalization level in dB (default: 0)
* `-n {rms|peak}` : Normalization type (default: peak)
* `-d {duration}` : Note sample duration in seconds (default: 6)
* `--from <note from>` : Note from (default: C0)
* `--to <note to>` : Note to (default: C8)
* `--format <format>` : Output file format (default: ogg)
* `--fileIndex <index>` : First note index in the file (default: 0)
* `--ffmpegParams <params>` : Additional parameters to be provided to ffmpeg

Example for a continuous (looped) instrument:
```bash
node slicer/slicer.js -l-20 -n rms flute.wav flute
```

Example for a plucked instrument:
```bash
node slicer/slicer.js -l-10 -n peak guitar.wav guitar
```

## 4. Import the sample files in your add-on

Create an `instruments` folder at the root of your add-on and one folder per instrument (ie `instruments/flute`) and put all the .ogg files generated by the slicer inside of it.

Add `Musician` as a `RequiredDeps` in your `.toc` files:
```
## RequiredDeps: Musician
```

Register your instrument into the `Musician.INSTRUMENTS` table. Use the `Musician.Instruments.lua` file as a reference. A good practice is to put this code with your constants declarations (ie under `constants/MyInstrumentPack.Instruments.lua`)

Example:
```lua
Musician.INSTRUMENTS["flute"] = {
	path = "Interface\\AddOns\\MyInstrumentPack\\instruments\\flute", -- Path to your instrument folder
	decay = 150, -- Decay duration in milliseconds
	isPercussion = false, -- Act as a percussion instrument using the single sample file (without extension) from path or picked from pathList using keyMod or roundRobin methods
	isPlucked = false, -- Set to true for plucked instruments such as guitar, harp etc.
	midi = 73, -- General MIDI instrument ID (0-127). For percussions, midi is its MIDI ID + 128
	loop = { 4, 5 }, -- Only needed for continuous instruments. The sample will be looped randomly after 4 and 5 seconds
	color = { 0.85, 0.95, 1 }, -- r, g, b
	source = "My awesome flute" -- Credits to author, software, library etc used to create the instrument. Displayed in the "About" window.
}
```

Add your instrument name into the `Musician.INSTRUMENTS_AVAILABLE` table. The instruments will show in the same order in the UI as in this table so you can just insert your instrument at the end of the table or insert it before/after another instrument.

A good practice is to insert it next to a similar instrument that is provided in the base add-on.

Examples:
```lua
-- Insert the flute at the end of the table
table.insert(Musician.INSTRUMENTS_AVAILABLE, "flute")
```

```lua
-- Insert the flute after the piano
local i = 1
while Musician.INSTRUMENTS_AVAILABLE[i] ~= "piano" and i <= #Musician.INSTRUMENTS_AVAILABLE do i = i + 1 end
table.insert(Musician.INSTRUMENTS_AVAILABLE, i + 1, "flute")
```

Your instrument may be used for one or more MIDI programs. The mapping is done in the `Musician.MIDI_INSTRUMENT_MAPPING` table. Use the `Musician.MidiMapping.lua` file as reference (you can name yours `constants/MyInstrumentPack.MidiMapping.lua`).

Example:
```lua
local Instrument = Musician.MIDI_INSTRUMENTS

Musician.MIDI_INSTRUMENT_MAPPING[Instrument.Flute] = "flute"
Musician.MIDI_INSTRUMENT_MAPPING[Instrument.BlownBottle] = "flute"
Musician.MIDI_INSTRUMENT_MAPPING[Instrument.Lead4Chiff] = "flute"
```

The final step consists in adding the localization strings for your new instrument in the `Musician.Locale` table. A good practice is to put this code with your locales declarations (ie under `locale/MyInstrumentPack.xx.lua` for each language):
```lua
Musician.Locale.en.INSTRUMENT_NAMES["flute"] = "Flute"
```
```lua
Musician.Locale.fr.INSTRUMENT_NAMES["flute"] = "Flûte"
```
```lua
Musician.Locale.de.INSTRUMENT_NAMES["flute"] = "Flöte"
```
```lua
Musician.Locale.zh.INSTRUMENT_NAMES["flute"] = "长笛"
```

## 5. Test your instrument
Test your new instrument in game. Make sure it's properly in tune and the volume level is correct. A good way to test it is to play it along with another similar instrument using the live keyboard.

## 6. Export the soundfont file
The soundfont file is useful for using your instrument in a DAW and/or a software synthesizer such as [VirtualMIDISynth](https://coolsoft.altervista.org/en/virtualmidisynth). This step is optional since this file is not used by the add-on but it's recommended to generate it for music composers. Check out the [Music producer guide](https://github.com/LenweSaralonde/Musician/wiki/Music-producer-guide) to learn more.

The soundfont file is generated by the **sfz-generator** tool. It's not designed to work for plugins so you'll have to use the following tricks to make it work with yours.

1. Create a `soundfonts` folder at the root of your add-on.
2. Make sure you have a `constants` folder at the root of your add-on.
3. Copy the `constants/Musician.Instruments.lua` file to your add-on's `constants` folder. Clear the contents of the `Musician.INSTRUMENTS` table then replace it by your instruments. Do the same for the `Musician.INSTRUMENTS_AVAILABLE` table.
4. Copy the `constants/Musician.MidiMapping.lua` file to your add-on's `constants` folder. Clear the contents of the `Musician.MIDI_INSTRUMENT_MAPPING` table then replace it by the mapping for your instruments. You can clear the `Musician.MIDI_PERCUSSION_MAPPING` table too but make sure not to remove it.
5. Copy the `constants/Musician.Midi.lua` file to your add-on's `constants` folder without touching it.
6. You may add the 3 files above in the ignore list of your packager file if you wish to track them in your repository.
7. Run the **sfz-generator** tool on your add-on folder: `node sfz-generator/sfz-generator.js <Add-on directory>` The process takes take long for looped instruments since the script will attempt to automatically detect looping points and the code is not optimized at all (the script goes exponentially faster as it progress).
8. Merge the contents from the Musician `soundfonts/Musician_GM_soundfonts.vmssf` with the one that has been generated. A good practice here is to make your own file (ie `soundfonts/MyInstrumentPack_GM_soundfonts.vmssf`).